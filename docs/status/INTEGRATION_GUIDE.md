# 統合ガイド：評価設計・データ取り扱い・ガードレール

**作成日**: 2025年1月31日  
**目的**: 実装した機能を既存システムに安全に統合するためのガイド

---

## 統合内容

### 1. エスカレーションエンジンの拡張 ✅

**ファイル**: `Dev/backend/services/escalation_engine_enhanced.py`

**統合方法**:
- 既存の`EscalationEngine`との互換性を保つ
- 拡張機能が失敗した場合は既存機能にフォールバック
- `main.py`で拡張エンジンを優先的に使用

**エラーハンドリング**:
- 拡張機能のインポート失敗時は既存エンジンを使用
- 拡張機能の初期化失敗時は既存エンジンを使用
- 拡張機能の実行失敗時は既存エンジンで再試行

### 2. データマスキング機能の統合 ✅

**統合箇所**: 
- `POST /api/meetings/ingest` - 会議データ取り込み時
- `POST /api/chat/ingest` - チャットデータ取り込み時

**エラーハンドリング**:
- マスキング失敗時は元のデータを使用（フォールバック）
- ログに警告を記録し、処理は継続

### 3. 監査ログ機能の統合 ✅

**統合箇所**:
- `POST /api/meetings/ingest` - 会議データ取り込み時
- `POST /api/chat/ingest` - チャットデータ取り込み時
- `POST /api/analyze` - 分析結果閲覧時
- `POST /api/escalate` - エスカレーション時

**エラーハンドリング**:
- ログ記録失敗時は処理を継続（ログ記録のみスキップ）
- ファイル書き込みエラー時はメモリ内に保持

### 4. 根拠引用機能の統合 ✅

**統合箇所**: `POST /api/analyze` - 分析結果の説明文生成時

**エラーハンドリング**:
- 根拠引用追加失敗時は元の説明文を使用（フォールバック）
- ログに警告を記録し、処理は継続

---

## エラーハンドリングの設計方針

### 1. フォールバック機能

**原則**: 新機能が失敗しても既存機能は動作する

- **拡張エスカレーションエンジン**: 失敗時は既存エンジンを使用
- **データマスキング**: 失敗時は元のデータを使用
- **監査ログ**: 失敗時はログ記録をスキップして処理を継続
- **根拠引用**: 失敗時は元の説明文を使用

### 2. エラーログ

**ログレベル**:
- **ERROR**: 処理が継続できない重大なエラー
- **WARNING**: フォールバックが発生した場合
- **INFO**: 正常な動作ログ

**ログ内容**:
- エラーの種類とメッセージ
- フォールバックが発生した理由
- 影響を受けたリソースID

### 3. 例外処理

**カスタム例外**:
- `ServiceError`: サービス呼び出しエラー
- `ValidationError`: バリデーションエラー
- `NotFoundError`: リソースが見つからないエラー

**例外の伝播**:
- 既存のエラーハンドラーで処理
- ユーザーフレンドリーなエラーメッセージを返す

---

## 動作確認方法

### 1. 基本的な動作確認

#### 1.1 エスカレーション機能の確認

```bash
# 分析結果を取得
curl -X POST http://localhost:8000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "meeting_id": "meeting_001",
    "chat_id": "chat_001"
  }'

# エスカレーションを実行
curl -X POST http://localhost:8000/api/escalate \
  -H "Content-Type: application/json" \
  -d '{
    "analysis_id": "<analysis_id>"
  }'
```

**確認ポイント**:
- エスカレーションデータに`stage`、`confidence`、`question`フィールドが含まれているか
- エラーが発生しても既存機能が動作するか

#### 1.2 データマスキング機能の確認

```bash
# 会議データを取り込み
curl -X POST http://localhost:8000/api/meetings/ingest \
  -H "Content-Type: application/json" \
  -d '{
    "meeting_id": "meeting_001",
    "transcript": "CFO: 1億円の投資が必要です。A社との取引も検討中です。"
  }'
```

**確認ポイント**:
- 議事録の個人名が役職名に置換されているか
- 金額が`[金額: 1億円規模]`にマスキングされているか
- 会社名が`[顧客名]`にマスキングされているか

#### 1.3 監査ログ機能の確認

```bash
# 監査ログを確認（実装後）
curl -X GET http://localhost:8000/api/audit/logs?limit=10
```

**確認ポイント**:
- ログファイルが生成されているか（`logs/audit/audit_YYYYMMDD.jsonl`）
- ログエントリが正しく記録されているか

### 2. エラーハンドリングの確認

#### 2.1 拡張機能の無効化テスト

```python
# 拡張機能を無効化してテスト
import os
os.environ["USE_ENHANCED_ESCALATION"] = "false"

# 既存機能が動作することを確認
```

#### 2.2 マスキング失敗時のテスト

```python
# 無効なデータでマスキングを試行
# エラーが発生しても処理が継続することを確認
```

---

## デプロイ前チェックリスト

### 必須チェック項目

- [ ] すべての新機能がエラーハンドリング付きで実装されている
- [ ] フォールバック機能が正しく動作する
- [ ] ログが適切に記録されている
- [ ] 既存機能が正常に動作する
- [ ] エラーが発生しても既存機能が動作する

### 動作確認項目

- [ ] エスカレーション機能が正常に動作する
- [ ] データマスキング機能が正常に動作する
- [ ] 監査ログが正常に記録される
- [ ] 根拠引用機能が正常に動作する

### パフォーマンス確認項目

- [ ] 新機能の追加によるパフォーマンスへの影響がない
- [ ] エラーハンドリングによるオーバーヘッドが許容範囲内

---

## トラブルシューティング

### 問題1: 拡張エスカレーションエンジンが動作しない

**症状**: エスカレーションデータに拡張機能のフィールドが含まれない

**対処方法**:
1. ログでエラーメッセージを確認
2. 既存エンジンにフォールバックしているか確認
3. インポートエラーがないか確認

### 問題2: データマスキングが動作しない

**症状**: マスキングされていないデータが保存される

**対処方法**:
1. ログで警告メッセージを確認
2. マスキングサービスが初期化されているか確認
3. エラー時は元のデータが使用される（正常動作）

### 問題3: 監査ログが記録されない

**症状**: ログファイルが生成されない

**対処方法**:
1. ログディレクトリの権限を確認
2. ディスク容量を確認
3. エラー時は処理が継続される（正常動作）

---

## 参考資料

- `Dev/backend/services/escalation_engine_enhanced.py` - 拡張エスカレーションエンジン
- `Dev/backend/services/data_masking.py` - データマスキングサービス
- `Dev/backend/services/audit_log.py` - 監査ログサービス
- `Dev/backend/services/evidence_citation.py` - 根拠引用サービス
- `Dev/backend/services/confidence_based_escalation.py` - 確信度に基づくエスカレーション
- `Dev/backend/services/staged_escalation.py` - 段階的エスカレーション
- `Dev/docs/design/EVALUATION_AND_GUARDRAIL_DESIGN.md` - 設計ドキュメント
