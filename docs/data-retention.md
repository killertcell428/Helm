# データ保存期間と自動削除 設計

## 二層保持モデル（心理的安全性のため推奨）

「原文は持たない。持つのはシグナルと監査だけ」と言い切るため、保持を三層に分離する。

| 層 | 内容 | 保持期間 | 備考 |
|----|------|----------|------|
| **原文** | トランスクリプト/チャット本文/添付資料 | 0〜7日（原則即時破棄） | 例外：正式な調査ケース化したときのみ、承認付きで延長 |
| **シグナル** | finding、パターンID、スコア、タイムスタンプ、根拠要約（マスク済み） | 90〜180日 | 改善PDCAのため |
| **監査証跡** | 誰がいつ何を見たか、モデル/ルール版本、承認ID | 365日 | 説明責任のため |

通常運用者は原文にアクセス不可。原文アクセスはケース化＋二段階承認＋理由入力＋監査でのみ可能。

## 対象ストア（実装上のマッピング）

上記二層モデルに寄せる場合のストア別保持日数。

| ストア | 説明 | 保持日数（推奨） | 備考 |
|--------|------|------------------|------|
| meetings_db / chats_db / materials_db | 原文（取り込み済みデータ） | 0〜7日 | 原則即時破棄。二層モデル採用時は超短期のみ |
| analyses_db | シグナル（分析結果） | 90〜180日 | シグナル層 |
| escalations_db / approvals_db / executions_db | 監査・実行履歴 | 365日 | 監査証跡層 |

※ 現行の「meetings/chats 90日」は、二層モデル未採用時の暫定値。二層モデル採用後は原文を超短期で破棄し、シグナルのみ中期保持とする。

## 削除ジョブのトリガー方針

1. **定期実行**: 日次バッチ（例: 深夜）で「作成日時が保持日数を超えたレコード」を削除。
2. **キー**: 各レコードの `created_at` または `ingested_at` を基準とする。存在しない場合は `updated_at` で代替。
3. **順序**: 参照整合性を考慮し、executions → approvals → escalations → analyses → meetings/chats/materials の順で削除するか、外部参照を持たないストアから先に削除。二層モデル採用時は原文（meetings/chats/materials）を最優先で削除（超短期）。
4. **実装場所**: バックエンドの `services/retention_cleanup.py` のようなモジュールで削除ロジックを実装し、cron または Cloud Scheduler から HTTP エンドポイント（例: `POST /api/admin/retention/cleanup`）を叩く。

## 設定（環境変数）

- `RETENTION_DAYS_MEETINGS`, `RETENTION_DAYS_CHATS`, `RETENTION_DAYS_ANALYSES`, `RETENTION_DAYS_ESCALATIONS` 等でストア別の日数を上書き可能にする。
- 未設定時は上表の推奨値をデフォルトとする。

## 注意

- 現状はインメモリ Dict のため、プロセス再起動でデータは消える。永続化（DB/Firestore）導入後、本設計に基づく削除ジョブを有効化する。
