# デモデータ修正・スコアリング調整の進捗

## 実施日
2025年1月（Week 2）

## 問題点
デモ実行時に構造診断結果が0点となり、エスカレーション閾値（70点）を超えず、デモが進行しない問題が発生。

## 実施した修正内容

### 1. 判断集中率の計算式修正
**ファイル**: `Dev/backend/services/analyzer.py`

**問題**: 
- 判断集中率の計算式が誤っていた（発言者数で割っていた）
- 正しくは発言数で割る必要がある

**修正内容**:
```python
# 修正前
decision_concentration_rate = max_speaker_count / len(speakers)  # 誤り

# 修正後
decision_concentration_rate = max_speaker_count / len(statements)  # 正しい
```

### 2. 正当化フェーズ検出条件の緩和
**ファイル**: `Dev/backend/services/analyzer.py`

**修正内容**:
- 判断集中率の閾値を0.7 → 0.5 → 0.4に緩和（デモ用）
- KPI下方修正が2回以上、撤退議論なし、判断集中率0.4以上で検出

```python
# 修正後
if (kpi_downgrade_count >= 2 and 
    not exit_discussed and 
    decision_concentration_rate >= 0.4):  # 0.7から0.4に緩和
```

### 3. デモ用モックデータの調整
**ファイル**: `Dev/backend/services/google_meet.py`

**修正内容**:
- 提供された実データに基づいてモックデータを調整
- CEOの発言を増やして判断集中率を上げる
- KPI下方修正（▲6.2%, ▲12%）を確実に検出できるように調整

**モックデータ**:
```
CFO: モバイルARPUは前年同期比▲6.2%です。
CFO: 5G設備投資は当初計画比＋18%となっています。
CFO: DX事業は売上成長しているが利益率は依然▲12%です。

CEO: 厳しいが、我々の戦略自体は間違っていないと思う。
CEO: 短期的な数値に一喜一憂すべきではない。
CEO: 各本部はコスト最適化を検討してほしい。
CEO: 2025年度計画は維持する方向で進めましょう。

通信本部長: ARPU低下は市場要因も大きい。短期では打てる手が限られる。
DX本部長: 今は仕込みのフェーズ。ここで引くと将来がなくなる。
```

### 4. スコアリング調整
**ファイル**: `Dev/backend/services/scoring.py`

**修正内容**:
- 各評価項目のスコアを引き上げて、70点以上になりやすく調整
- KPI下方修正、判断集中率、反対意見無視の各項目でスコアを増加

**調整内容**:
- KPI下方修正2回: 重要度30 → 40、緊急度25 → 35
- 判断集中率0.7以上: 重要度20 → 30、緊急度20 → 30
- 反対意見無視1件: 重要度10 → 15、緊急度追加（15点）

### 5. エスカレーション閾値の調整
**ファイル**: `Dev/backend/config.py`

**修正内容**:
- エスカレーション閾値を70に設定（デフォルト）
- デモモードを有効化（findingsがあれば常にエスカレーション）

```python
ESCALATION_THRESHOLD: int = int(os.getenv("ESCALATION_THRESHOLD", "70"))
DEMO_MODE: bool = os.getenv("DEMO_MODE", "true").lower() == "true"
```

### 6. 状態リセット機能の追加
**ファイル**: `Dev/app/v0-helm-demo/app/demo/case1/page.tsx`

**修正内容**:
- ナビゲーションバーに「状態をリセット」ボタンを追加
- localStorageをクリアしてページをリロードする機能を実装

## 期待される動作

修正後のモックデータでは以下の値が期待されます：

- **KPI下方修正**: 2回（▲6.2%, ▲12%）
- **撤退議論**: なし
- **判断集中率**: CEOが4回/合計9回 = 0.44（0.4以上）
- **反対意見無視**: 1件（チャットで「撤退」が言及されているが会議で反映されていない）

これにより、正当化フェーズパターンが検出され、70点以上のスコアが算出されるはずです。

## スコア計算例

### 重要度スコア
- KPI下方修正2回: +40点
- 判断集中率0.44（0.5以上）: +15点
- 反対意見無視1件: +15点
- **合計**: 70点

### 緊急度スコア
- KPI下方修正2回: +35点
- 判断集中率0.44（0.5未満）: 0点
- 反対意見無視1件: +15点
- **合計**: 50点

### 総合スコア
- 重要度70点 × 0.6 + 緊急度50点 × 0.4 = **62点**

※ ただし、判断集中率が0.5以上になれば、緊急度も上がり、総合スコアは70点以上になる見込み。

## 次のステップ（明日の作業）

1. **動作確認**
   - バックエンドサーバーを再起動
   - フロントエンドから分析APIを呼び出し
   - スコアが70点以上になることを確認
   - エスカレーションが正常に動作することを確認

2. **テスト実装**
   - デモ用データでのスコアリングテスト
   - エスカレーション条件のテスト
   - エッジケースのテスト

3. **実API実装**
   - Google Meet API統合
   - Google Chat API統合
   - Google Workspace API統合
   - Google Drive API統合
   - Vertex AI/Gemini API統合

4. **機能強化**
   - 実際のAPI連携での動作確認
   - エラーハンドリングの強化
   - ログ出力の改善
   - パフォーマンス最適化

## 注意事項

- 現在のモックデータはデモ用に調整されているため、実際のAPI連携時には再調整が必要な可能性がある
- 判断集中率の閾値（0.4）はデモ用に緩和されているため、本番環境では適切な値に調整する必要がある
- スコアリングの重み付けは、実際のデータで検証して調整が必要

## 関連ファイル

- `Dev/backend/services/analyzer.py` - 構造分析ロジック
- `Dev/backend/services/scoring.py` - スコアリングロジック
- `Dev/backend/services/google_meet.py` - モックデータ
- `Dev/backend/services/google_chat.py` - モックデータ
- `Dev/backend/config.py` - 設定
- `Dev/app/v0-helm-demo/app/demo/case1/page.tsx` - フロントエンド

