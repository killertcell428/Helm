# 評価設計とガードレール設計

**作成日**: 2025年1月31日  
**目的**: 審査員からの指摘事項（評価設計、データ取り扱い、ガードレール）をクリアするための設計と実装

---

## B. 評価設計（検知精度・誤検知・再現性）の強化

### 1. 評価システムの根拠設計

#### 1.1 重み（0.6/0.4）の根拠

**ルールベース（重み: 0.6）の利点**:
- **見逃しゼロの安全網**: 定量的指標に基づくため、再現性が高い
- **客観性**: 数値に基づく判断のため、バイアスが入りにくい
- **説明可能性**: なぜそのスコアになったかが明確

**LLM（重み: 0.4）の利点**:
- **文脈理解**: 会議の空気感やチャットの本音を理解
- **柔軟性**: 新しいパターンや複雑な状況に対応
- **多視点評価**: 4つのロール視点から同時評価

**組み合わせの根拠**:
- ルールベースの客観性とLLMの柔軟性を両立
- 見逃しを防ぎつつ、過剰反応を抑制
- 実運用での検証結果（可能な範囲で）に基づく調整

#### 1.2 閾値（70点）の決定根拠

**決定方法**:
- 初期値: ルールベースとLLMの平均スコア分布から決定
- 調整: 実データでの検証結果に基づく調整
- 誤検知率と見逃し率のバランスを考慮

**誤検知コスト**:
- 誤検知で経営層を呼び出すコスト: 時間的コスト、信頼性への影響
- 見逃しコスト: 意思決定の詰まりが深刻化するリスク
- 安全側を採用するため、誤検知が増える前提で運用設計

### 2. 評価表の実装

#### 2.1 評価データの収集

**ラベル付けした会議ログ**:
- 手動でラベル付けした会議ログN件（初期は10-20件程度）
- 各ログに対して「意思決定の詰まりあり/なし」のラベル
- パターンIDごとのラベル（B1_正当化フェーズ、ES1_報告遅延など）

**評価指標**:
- **Precision（適合率）**: 検出された問題のうち、実際に問題だった割合
- **Recall（再現率）**: 実際の問題のうち、検出できた割合
- **F1スコア**: PrecisionとRecallの調和平均
- **誤検知率**: 問題がないのに検出した割合

#### 2.2 評価表の表示

**評価結果の可視化**:
- パターンIDごとのPrecision/Recall
- 全体のPrecision/Recall
- 誤検知例のリスト

### 3. 誤検知例と対策

#### 3.1 代表的な誤検知例

**例1: 正常な議論を「正当化フェーズ」と誤検知**
- **原因**: KPI下方修正が2回以上あったが、実際は健全な議論が行われていた
- **対策**: LLM評価の重みを上げ、文脈をより重視

**例2: 緊急度の過大評価**
- **原因**: ルールベースで緊急度がHIGHと判定されたが、実際はMEDIUM程度
- **対策**: 緊急度判定にLLM評価を組み合わせ、安全側を採用

**例3: パターンIDの誤分類**
- **原因**: ES1_報告遅延とB1_正当化フェーズを混同
- **対策**: パターン判定の閾値を調整、複数パターンの同時検出を許可

#### 3.2 誤検知対策の実装

**重要度に応じた段階（通知→レビュー→承認依頼→議題化）**:
- 通知→レビュー→承認依頼→強制議題化の段階設計
- 確信度が低い場合は「質問として投げる」

**サイレンス期間**:
- 同じパターンが短時間に複数回検出された場合、一定期間（例: 24時間）は再通知しない
- アラート疲れを防ぐ

**承認UI**:
- Executiveが「誤検知」と判断した場合、その情報を学習に活用
- 誤検知パターンの記録と分析

### 4. 運用設計

#### 4.1 通知の段階設計

**段階1: 通知（Notification）**
- スコア: 50-60点
- 重要度: MEDIUM
- アクション: 関係者に通知のみ、承認不要

**段階2: レビュー（Review）**
- スコア: 60-70点
- 重要度: MEDIUM-HIGH
- アクション: 関係者がレビューし、必要に応じて対応

**段階3: 承認依頼（Approval Request）**
- スコア: 70-80点
- 重要度: HIGH
- アクション: Executiveに承認を依頼

**段階4: 強制議題化（Forced Agenda）**
- スコア: 80点以上
- 重要度: CRITICAL
- アクション: 次回会議に強制的に議題として追加

#### 4.2 サイレンス期間の実装

**実装内容**:
- 同じパターンが24時間以内に複数回検出された場合、2回目以降は通知しない
- サイレンス期間は設定可能（デフォルト: 24時間）

---

## C. データ取り扱い（プライバシー / 機密 / 監査）

### 1. 保存するデータ / 保存しないデータ

#### 1.1 保存するデータ

**会議データ**:
- 議事録のテキスト（マスキング後）
- 参加者リスト（役職のみ、個人名はマスキング）
- 会議のメタデータ（日時、会議名など）

**チャットデータ**:
- チャットメッセージのテキスト（マスキング後）
- チャンネル名
- メッセージのタイムスタンプ

**分析結果**:
- 意思決定の詰まりの検出結果
- スコア、重要度、緊急度
- パターンID

#### 1.2 保存しないデータ

**個人情報**:
- 個人名（マスキング）
- メールアドレス
- 電話番号

**センシティブ情報**:
- 具体的な金額（数値は範囲で表現）
- 顧客名、取引先名
- 機密プロジェクト名

**生データ**:
- 元の議事録ファイル（分析後は削除）
- 元のチャットログ（分析後は削除）

### 2. マスキング方針

#### 2.1 個人名のマスキング

**実装方法**:
- NER（Named Entity Recognition）を使用して個人名を検出
- 個人名を役職名に置換（例: "田中太郎" → "CFO"）
- 同じ人物は同じ役職名に統一

#### 2.2 センシティブ語のマスキング

**マスキング対象**:
- 具体的な金額（例: "1億円" → "[金額: 1億円規模]"）
- 顧客名、取引先名（例: "A社" → "[顧客名]"）
- 機密プロジェクト名（例: "プロジェクトX" → "[プロジェクト名]"）

**実装方法**:
- キーワードリストに基づくマスキング
- LLMを使用したセンシティブ情報の検出（将来実装）

### 3. ロールベースアクセス制御

#### 3.1 アクセス権限の設計

**Executive（経営層）**:
- 全データへのアクセス
- 詳細な分析結果の閲覧
- エスカレーション履歴の閲覧

**Manager（管理職）**:
- 自分の部署に関連するデータのみ
- 分析結果のサマリー閲覧
- エスカレーション履歴の閲覧（自分の部署のみ）

**Staff（一般社員）**:
- 自分のプロジェクトに関連するデータのみ
- 分析結果のサマリー閲覧
- エスカレーション履歴の閲覧不可

#### 3.2 データの粒度制御

**経営層に見せる粒度**:
- 詳細な分析結果
- 証拠となる発言の引用
- パターンIDと説明

**管理職に見せる粒度**:
- 分析結果のサマリー
- パターンIDと簡易説明
- 証拠の要約

### 4. 監査ログ

#### 4.1 監査ログの記録内容

**記録する情報**:
- いつ（タイムスタンプ）
- 誰が（ユーザーID、ロール）
- 何を見たか（アクセスしたデータ、実行した操作）
- どこから（IPアドレス、デバイス情報）

#### 4.2 監査ログの保存

**保存期間**:
- 最低1年間保存
- 重要な操作（エスカレーション、承認など）は永続保存

**保存形式**:
- 構造化ログ（JSON形式）
- 改ざん防止（ハッシュ値の記録）

---

## D. 失敗時の制御（ガードレール）

### 1. 重要度に応じた段階（通知→レビュー→承認依頼→議題化）

#### 1.1 エスカレーション段階の設計

**段階1: 通知（Notification）**
- スコア: 50-60点
- 重要度: MEDIUM
- アクション: 関係者に通知のみ、承認不要
- 説明: 「意思決定の詰まりの兆候が検出されました。監視を継続します。」

**段階2: レビュー（Review）**
- スコア: 60-70点
- 重要度: MEDIUM-HIGH
- アクション: 関係者がレビューし、必要に応じて対応
- 説明: 「意思決定の詰まりの可能性があります。レビューをお願いします。」

**段階3: 承認依頼（Approval Request）**
- スコア: 70-80点
- 重要度: HIGH
- アクション: Executiveに承認を依頼
- 説明: 「意思決定の詰まりが検出されました。承認をお願いします。」

**段階4: 強制議題化（Forced Agenda）**
- スコア: 80点以上
- 重要度: CRITICAL
- アクション: 次回会議に強制的に議題として追加
- 説明: 「緊急の意思決定の詰まりが検出されました。次回会議で必ず議論してください。」

#### 1.2 アラート疲れ対策

**サイレンス期間**:
- 同じパターンが24時間以内に複数回検出された場合、2回目以降は通知しない
- サイレンス期間は設定可能（デフォルト: 24時間）

**通知頻度の制限**:
- 同じユーザーへの通知は1日最大3回まで
- 重要度がCRITICALの場合は制限を緩和

### 2. 説明文の根拠引用

#### 2.1 根拠引用の実装

**発話IDの記録**:
- 会議議事録の各発言に一意のIDを付与
- チャットメッセージにも一意のIDを付与

**タイムスタンプの記録**:
- 各発言のタイムスタンプを記録
- 分析結果に証拠となる発言のタイムスタンプを引用

**説明文の生成**:
- 説明文には必ず根拠となる発言IDとタイムスタンプを含める
- 例: 「正当化フェーズの兆候が検出されました（発言ID: M001, タイムスタンプ: 2025-02-01T10:30:00Z）」

#### 2.2 説明可能性の確保

**LLMの説明文の検証**:
- LLMが生成した説明文が根拠に基づいているか検証
- 根拠がない説明文は生成しない

**説明文の構造化**:
- 説明文は以下の構造で生成:
  - 検出されたパターン
  - 根拠となる発言（発言ID、タイムスタンプ付き）
  - スコアの算出根拠

### 3. 確信度が低い時の「質問として投げる」

#### 3.1 確信度の計算

**確信度の算出方法**:
- ルールベーススコアとLLMスコアの差が大きい場合、確信度が低いと判断
- 複数のロール視点で評価が分かれる場合、確信度が低いと判断

**確信度の閾値**:
- 高確信度: 80%以上 → 通常のエスカレーション
- 中確信度: 60-80% → レビュー段階
- 低確信度: 60%未満 → 質問として投げる

#### 3.2 質問として投げる実装

**質問の形式**:
- 「意思決定の詰まりの可能性がありますが、確信度が低いです。以下の点について確認をお願いします:」
- 確認すべき点をリスト形式で提示

**質問の送信先**:
- 関係者（Manager、Staff）に質問を送信
- Executiveには送信しない（アラート疲れを防ぐ）

---

## 実装計画

### Phase 1: 評価設計の実装（優先度: 高）

1. **評価データの収集機能**
   - ラベル付けした会議ログの管理
   - 評価指標（Precision/Recall）の計算

2. **評価表の表示機能**
   - パターンIDごとのPrecision/Recall
   - 誤検知例のリスト

3. **誤検知対策の実装**
   - 重要度に応じた段階（通知→レビュー→承認依頼→議題化）
   - サイレンス期間

### Phase 2: データ取り扱いの実装（優先度: 高）

1. **データマスキング機能**
   - 個人名のマスキング
   - センシティブ語のマスキング

2. **ロールベースアクセス制御**
   - アクセス権限の実装
   - データの粒度制御

3. **監査ログ**
   - 監査ログの記録
   - 監査ログの保存

### Phase 3: ガードレールの実装（優先度: 高）

1. **重要度に応じた段階（通知→レビュー→承認依頼→議題化）**
   - エスカレーション段階の実装
   - アラート疲れ対策

2. **説明文の根拠引用**
   - 発話IDの記録
   - 説明文への根拠引用

3. **確信度が低い時の質問機能**
   - 確信度の計算
   - 質問として投げる実装

---

## 参考資料

- 審査員からの指摘事項は内部メモのためリポジトリに含みません
- `Dev/backend/services/escalation_engine.py` - エスカレーションエンジン
- `Dev/backend/services/ensemble_scoring.py` - アンサンブルスコアリング
