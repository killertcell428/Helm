# ベンチマーク・評価実験設計

**目的**: 有効性の定量証拠を示すためのベンチマーク設計、2つの定量KPI、検証方法（混同行列＋アブレーション）を明文化する。

---

## 1. 効果の主張を2つの定量KPIで固定

### KPI① 議題化までの日数

- **定義**: 検知→承認→次回会議議題化までの日数
- **測定**: エスカレーション作成日から、経営会議等で該当案件が議題に上がった日までの日数
- **期待**: Helm導入により、介入ループが回ることで議題化までのリードタイムが短縮する

### KPI② 誤検知率（FP）と見逃し（FN）の運用コスト仮定

- **誤検知率（FP）**: 問題がないのにアラートを出した割合。経営層の時間的コスト・信頼性への影響を仮定して許容水準を設定
- **見逃し（FN）**: 実際に問題があったのに検出しなかった割合。意思決定の詰まりの深刻化リスクを仮定
- **運用コスト仮定**: FP/FNの非対称性を明示し、Precision重視（過剰アラート抑制）またはRecall重視（見逃し抑制）のどちらを優先するかを組織ごとに設定可能に

---

## 2. 検証方法（最小セット）

- **入力**: 匿名化疑似ログ N ケース（目安: N=20。既存デモ Case1/2/3 をベースに拡張、合成データ可）
- **正解ラベル（Ground Truth）**:
  - ① 判断遅延（B1系）
  - ② 責任曖昧（ES2系）
  - ③ バイアス/反対意見抑圧（B3系）
  - ④ リスク報告遅延（ES1系）
- **評価**:
  - **混同行列**: TP / FP / FN / TN を算出し、Precision（重視）、Recall、F1、誤検知率を報告
  - **アブレーション**: ルールのみ vs LLMのみ vs ハイブリッド（0.6/0.4）の3条件で同一データを分析し、各条件の Precision/Recall を比較
- **ケーススタディ**: 代表的な3本（検知が効いた例、誤検知例、見逃し例）を簡潔に記述

---

## 3. ベンチマーク設計の詳細

### 3.1 入力データ

- 会議＋チャット（匿名化/合成可）
- 既存デモ data（Case1/2/3）をベースに、正解ラベル付きサンプルを最低 5〜10 件用意し、段階的に N=20 まで拡張

### 3.2 正解ラベル（Ground Truth）

| ラベル種別 | pattern_id 例 | 説明 |
|------------|---------------|------|
| 判断遅延 | B1_正当化フェーズ | KPI悪化が続くのに戦略変更・撤退議論がない |
| 責任曖昧 | ES2_エスカレーション不明確 | エスカレーション基準・責任の所在が曖昧 |
| バイアス/反対意見抑圧 | B3_反対意見無視 | 反対意見が適切に反映されていない |
| リスク報告遅延 | ES1_報告遅延 | リスク認識があるが経営層への報告が遅延 |

### 3.3 指標

- **Precision**（重視）: TP / (TP + FP)
- **Recall**: TP / (TP + FN)
- **F1**: 2 × Precision × Recall / (Precision + Recall)
- **誤検知率**: FP / (TP + FP)
- **重大アラートの誤検知率**: 閾値超過でエスカレしたもののうち、実際は不要だった割合

### 3.4 labels.json の拡張案

分析結果との突き合わせを行うため、現行スキーマに以下を追加する案:

- `analysis_id`: 対象となる分析結果ID。ラベルと分析結果を突き合わせて TP/FP/FN を計算する際に使用
- （既存）`meeting_id`, `chat_id`, `pattern_id`, `is_structural_issue`, `notes`

---

## 4. アブレーション設計

### 4.1 実験条件

| 条件 | ルール重み | LLM重み | 説明 |
|------|------------|---------|------|
| ルールのみ | 1.0 | 0 | StructureAnalyzer の結果のみでスコア・アラート判定 |
| LLMのみ | 0 | 1.0 | マルチ視点LLMの平均のみでスコア・アラート判定 |
| ハイブリッド | 0.6 | 0.4 | 現行のアンサンブル（EnsembleScoringService） |

### 4.2 実装

- `EnsembleScoringService` の `combine` において、重みを環境変数（例: `ENSEMBLE_RULE_WEIGHT`, `ENSEMBLE_LLM_WEIGHT`）で外部化し、上記3条件を再現可能にする
- 同一入力データに対して3条件それぞれで分析を実行し、各条件の Precision / Recall / F1 を算出

### 4.3 測定

- 各条件で同一データを分析し、混同行列を出力
- ルールのみ vs LLMのみ vs ハイブリッド の比較表をドキュメント化

---

## 5. 介入効果測定の型

- **代理指標例**: 意思決定までの日数、会議回数、差し戻し回数、未決事項の滞留、リスク報告遅延日数
- **「アラート→承認→介入→再観測」ループ**: 検知日→承認日→議題化日（またはアクション完了日）を記録し、KPI①との整合を取る
- 測定タイミング・サンプル設計は運用フェーズで確定。最小では N=20 の疑似ログで混同行列＋アブレーション結果を記事・資料に掲載する

---

## 6. 関連ドキュメント

- 評価・ガードレールの詳細: [EVALUATION_AND_GUARDRAIL_DESIGN.md](./EVALUATION_AND_GUARDRAIL_DESIGN.md)
- 誤検知API・精度指標API: 実装済み（`POST /api/feedback/false-positive`, `GET /api/metrics/accuracy`）
